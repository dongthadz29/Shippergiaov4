<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Shipper Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="style.css">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<header>
  üöö Shipper Map
  <button id="btnCenter">üìç</button>
</header>

<div id="map"></div>

<!-- PANEL TR√äN: L∆ØU -->
<div class="panel top">
  <input id="customer" placeholder="T√™n kh√°ch">
  <input id="phone" placeholder="SƒêT">
  <input id="coord" placeholder="To·∫° ƒë·ªô (ch·∫°m b·∫£n ƒë·ªì)" readonly>

  <button id="btnSave">üíæ L∆∞u ƒë·ªãa ƒëi·ªÉm</button>

  <div class="row">
    <button id="btnExport">‚¨áÔ∏è Xu·∫•t</button>
    <label class="import-btn">
      ‚¨ÜÔ∏è Nh·∫≠p
      <input type="file" id="importFile" hidden>
    </label>
  </div>
</div>

<!-- PANEL D∆Ø·ªöI: DANH S√ÅCH -->
<div class="panel bottom">
  <div id="list"></div>
</div>

<div id="navBox"></div>
<div id="distanceBox"></div>

<script src="osrm.js"></script>

<script>
/* ================= MAP ================= */
const map = L.map('map',{zoomControl:true}).setView([10.7769,106.7009],15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);

/* ================= ICON ================= */
const meIcon = L.divIcon({
  className:'me',
  html:'<div class="me-arrow"></div><div class="me-text">T√¥i</div>',
  iconSize:[30,30],
  iconAnchor:[15,15]
});

/* ================= STATE ================= */
let myLatLng = null;
let myMarker = null;
let tempLatLng = null;
let activeTarget = null;
let activeCustomer = null;

/* ================= GPS FIX (KH√îNG TR√îI) ================= */
navigator.geolocation.watchPosition(
  pos=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    if(!myLatLng){
      myLatLng=[lat,lng];
      map.setView(myLatLng,17);
      myMarker = L.marker(myLatLng,{icon:meIcon}).addTo(map);
    }else{
      myLatLng=[lat,lng];
      myMarker.setLatLng(myLatLng);
    }

    if(activeTarget) updateDistance();
  },
  err=>alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS"),
  { enableHighAccuracy:true, maximumAge:2000, timeout:10000 }
);

btnCenter.onclick=()=>{
  if(myLatLng) map.setView(myLatLng,18);
};

/* ================= CLICK MAP FIX ================= */
map.on('click',e=>{
  tempLatLng = e.latlng;
  coord.value = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
});

/* ================= DATA ================= */
let locations = JSON.parse(localStorage.getItem('locations') || '[]');
let markers=[];

function saveStorage(){
  localStorage.setItem('locations',JSON.stringify(locations));
}

function render(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  list.innerHTML='';

  locations.forEach((l,i)=>{
    const m=L.marker([l.lat,l.lng])
      .addTo(map)
      .bindTooltip(`${l.customer}<br>${l.phone}`,{permanent:false});
    markers.push(m);

    const d=document.createElement('div');
    d.className='item';
    d.innerHTML=`
      <b>${l.customer}</b><br>${l.phone}
      <div class="row">
        <button onclick="goTo(${i})">ƒêi t·ªõi</button>
        <button onclick="del(${i})">Xo√°</button>
      </div>
    `;
    list.appendChild(d);
  });
}
render();

/* ================= SAVE FIX ================= */
btnSave.onclick=()=>{
  if(!tempLatLng) return alert("Ch·∫°m b·∫£n ƒë·ªì ƒë·ªÉ l·∫•y to·∫° ƒë·ªô");
  locations.push({
    id:Date.now(),
    customer:customer.value,
    phone:phone.value,
    lat:tempLatLng.lat,
    lng:tempLatLng.lng
  });
  tempLatLng=null;
  coord.value='';
  saveStorage();
  render();
};

/* ================= GO ================= */
function goTo(i){
  const l=locations[i];
  activeTarget=[l.lat,l.lng];
  activeCustomer=l;
  drawOSRMRoute(myLatLng,activeTarget);
  map.setView(activeTarget,17);
}

/* ================= DELETE ================= */
function del(i){
  locations.splice(i,1);
  saveStorage();
  render();
}

/* ================= DISTANCE + ARRIVAL ================= */
function updateDistance(){
  if(!myLatLng||!activeTarget) return;
  const d=map.distance(myLatLng,activeTarget);
  distanceBox.innerText = d<1000 ? `C√≤n ${Math.round(d)} m` : `C√≤n ${(d/1000).toFixed(2)} km`;
  distanceBox.style.display='block';

  if(d<15){
    alert(`üéØ ƒê√£ ƒë·∫øn n∆°i\n${activeCustomer.customer}\n${activeCustomer.phone}`);
    activeTarget=null;
    navBox.style.display='none';
  }
}

/* ================= EXPORT / IMPORT ================= */
btnExport.onclick=()=>{
  const blob=new Blob([JSON.stringify(locations)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='shipper-map.json';
  a.click();
};

importFile.onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      locations=JSON.parse(r.result);
      saveStorage();
      render();
    }catch{
      alert("File kh√¥ng h·ª£p l·ªá");
    }
  };
  r.readAsText(f);
};
</script>

</body>
</html>
